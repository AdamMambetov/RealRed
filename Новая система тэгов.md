# Новая система тэгов

## RR_TagManager_AC

Находится в `/All/Plugins/RR_Core/Components/Managers`. Является заменой _TAG_Manager_Estate_AC_. В нём хранятся текущие тэги (Лейер, Раздел и т.д.) и стейджи (Дом, Квартира, Вид из окон и т.д.). Какие тэги он в себе хранит указаны в переменной MessageTags.

![[Pasted image 20251106160522.png]]

Должен быть добавлен к GameMode проекта. Все его методы добавлены в категорию _TagManager_.

![[Pasted image 20251106145752.png]] 


### Работа с тэгами (GaemplayTags)

#### Добавление, изменение и удаление тэгов

Для добавления, изменения и удаления тэгов есть 4 функции:

![[Pasted image 20251106152916.png]]

1. AddTag - Добавляет указанный тэг. Replace - заменить уже существующий тэг на этот.
	- Пример: В _RR_TagManager_AC_ есть _RR Layer.Генплан_. Если вызвать эту функцию с Replace = false и Tag = _RR Layer.Местоположение_, то в _RR_TagManager_AC_ будут тэги _RR Layer.Генплан_, _RR Layer.Местоположение_. А если Replace = true, то будет только тэг _RR Layer.Местоположение_.
	- Как он понимает какие тэги надо удалить? Он ищет в переменной _MessageTags_ по неполному сравнению корневой тэг (у _RR Layer.Генплан_ это _RR Layer_) и он удаляет все тэги, у которых есть этот корневой тэг.
2. AddTags - Добавляет указанные тэги. Replace - заменить уже существующий тэг на эти.
3. RemoveTag - Удаляет указанный тэг. Exact Remove - удалить по точному сравнению (такой же параметр есть у функции Matches Tag).
4. RemoveTags - Удаляет указанные тэги.

#### Получение сообщений об изменении тэгов

Предыдущие 4 функции отправляют сообщение о том, какой корневой тэг изменился и какие теперь тэги с этим корневым тэгом. Чтобы подписаться на изменения тэга надо использовать Listen For Gamplay Messages:

![[Pasted image 20251106155303.png]]

- Channel - корневой тэг (например _RR Layer_)
- PayloadType - какой тип будет у выходного параметра Payload (GameplayTagContainer)
- MatchType - здесь он роли не играет
- ActualChannel - вернёт тоже самое, что и указано в Channel
- Payload - тэги из _RR_TagManager_AC_ у которых корневой тэг совпадает с указанным в Channel

#### Получение тэгов

Чтобы получить тэг есть 3 функции:

![[Pasted image 20251106160723.png]]

1. GetAllTags - возвращяет все тэги
2. GetTag - возвращяет 1-ый тэг из тех, у кого корневым тэгом является входной параметр Tag
3. GetEqualTags - возвращяет все тэги, у кого корневым тэгом является входной параметр Tag

#### Переключение разделов

Для переключения разделов используется функция ChangeRazdel:

![[Pasted image 20251106161445.png]]

Информация о разделах хранится в дата ассете _RR_Razdels_DA_. Если надо поменять логику разделов, то необходимо продублировать этот дата ассет в корневую директорию проекта и изменить переменную RazdelsData в _RR_TagManager_AC_.
### Работа со стейджами (Stages)

Стейдж - это такой тэг, у которого есть список номеров данного тэга. Например, вместо создания 10 тэгов для домов, можно обойтись одним тэгом _RR Stage.Дом_ и 10 номерами домов в списке. Есть небольшой минус по сравнению с тэгами, непонятно сколько стейджей есть и что каждый из них значит.
![[Pasted image 20251106163433.png]] ![[Pasted image 20251106163037.png]]

#### Создание стейджей

Для создания стейджа необходимо добавить дочерний тэг к тэгу _RR Stage_.

![[Pasted image 20251106162549.png]]

#### Добавление, изменение и удаление стейджей

Для добавления, изменения и удаления стейджей есть 5 функций:

![[Pasted image 20251106172412.png]]

1. AddStage - добавить стейдж с одним элементом из списка.
	- Tag - тэг стейджа (например _RR Stage.Дом_)
	- Stage - номер стейджа
	- Replace - удалить все номера данного стейджа, кроме указанного в Stage
2. AddStages - добавить стейдж со списком элементов.
	- Stage - структура с тэгом стейджа и списком элементов
	- Replace - удалить все номера данного стейджа, кроме указанных в Stage
3. RemoveStage - удаляет номер у стейджа. Если больше нет номеров в стейдже, то удаляется весь стейдж.
4. RemoveStages - удаляет номера у стейджа. Если больше нет номеров в стейдже, то удаляется весь стейдж.
5. RemoveAllStages - удаляет стейдж по тэгу.

#### Получение сообщений об изменении стейджей

Предыдущие 5 функций отправляют сообщение о том, какой стейдж изменился. Чтобы подписаться на изменения стейджа надо использовать Listen For Gamplay Messages:

![[Pasted image 20251106180407.png]]

- Channel - тэг стейджа (например _RR Stage.Дом_)
	- Для получения сообщений обо всех стейджах нужно указать _RR Stage_
- PayloadType - какой тип будет у выходного параметра Payload (Stage)
- MatchType - здесь он роли не играет
	- Если в Channel указан тэг только тэг _RR Stage_, то надо выставить значение Partial Match
		- Parital Match означает, что будут слушаться все сигналы содержащие тэг Channel и его дочерние тэги
- ActualChannel - вернёт тоже самое, что и указано в Channel
	- Если в Channel указан тэг только тэг _RR Stage_, то вернётся тэг, который был изменён
- Payload - структура со списком стейджей

#### Получение стейджей

Для получения стейджа используется функция GetStage, которая возвращяет список стейджей указанного в Tag.

![[Pasted image 20251106181523.png]]

## RR_VisibilityManager_AC

Находится в `/All/Plugins/RR_Core/Components/Managers`. Является заменой _Visibility_Estate_AC_. Он меняет тэги у акторов с компонентом _GameplayTags_ у которых есть AdditionalTag _RR Visibility_.

![[Pasted image 20251106173920.png]]

### Как указать условия появления/скрывания актора?

Для этого необходимо в компоненте _GameplayTags_ в переменной _AdditionalTags_ добавить элемент. В качестве ключа тэг _RR Visibility_, а значение - тэги и стейджи на которых он будет виден. Стейджи добавлять необязательно. Проверяется среди тэгов и стейджей в _RR_TagManager_AC_ есть ли хотя бы один тэг или стейдж из TagContainer у актора.

![[Pasted image 20251106175748.png]]

Теперь при изменении тэгов (_RR Layer_, _RR Amenity_ и т.д.) или стейджей в _RR_TagManager_AC_ будет меняться тэг _RR Visibility_ у актора. _RR_VisibilityManager_AC_ добавляет актору 1 из 2-х тэгов: _RR Visibility.Hidden.Hide_ - актора не видно или _RR Visibility.Visible.Show_ - актор виден.

### Как получить сообщение об изменении видимости актора?

В компоненте _GameplayTags_ есть делегат _On Gameplay Tags Changed Delegate_. 

![[Pasted image 20251107135745.png]] ![[Pasted image 20251107140059.png]]

Он вызывается при изменении тэгов у _GameplayTags_ компонента и возвращяет все тэги из компонента. Для проверки видимости можно использовать такой метод:

![[Pasted image 20251107140902.png]]

В данном случае проверка тэгов будет по опредённой очерёдности, т.к. GameplayTagContainer сортирует тэги.

Если надо проверять тэги в определённом порядке можно проверять каждый тэг вручную:

![[Pasted image 20251107141223.png]]

### Как поменять логику изменения видимости в RR_VisibilityManager_AC?

Создайте дочерний блюпринт от _RR_VisibilityCommand_.

![[Pasted image 20251107151112.png]]

В нём переопределите функцию Execute и в ней можете менять логику изменения логики. В базовом классе есть пример изменения видимости у актора.

![[Pasted image 20251107151533.png]]

Затем в GameMode проекта создайте экземпляр класса новой команды и задайте переменную VisibilityCommand в _RR_VisibilityManager_AC_.

![[Pasted image 20251107151411.png]]

## RR_ClickManager_AC

Находится в `/All/Plugins/RR_Core/Components/Managers`. Является заменой _Click_Manager_Estate_AC_. Он позволяет подлетать к акторам.

### Как подлететь к актору с помощью таргета?

Добавьте актору _GameplayTags_ компонент. В AdditionalTags добавьте элемент: в качестве ключа указ
